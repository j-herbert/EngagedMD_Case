CREATE OR REPLACE VIEW ENGAGEDMD_PROD.PUBLIC.ENGAGEDMD_CASE_VW as (
WITH cat (CAT_ID, CAT_NAME, CAT_DESC) as (
SELECT CategoryID, CategoryName, Description
FROM ENGAGEDMD_PROD.PUBLIC.CATEGORIES
),
cust (CUST_ID, CUST_NAME, CUST_CITY, CUST_REGION, CUST_COUNTRY) as (
SELECT CUSTOMERID, COMPANYNAME, CITY, REGION, COUNTRY
FROM ENGAGEDMD_PROD.PUBLIC.CUSTOMER_LIST
),
emp (EMP_ID, EMP_NAME, EMP_TITLE, EMP_CITY, EMP_REGION, EMP_COUNTRY, REPORTS_TO_ID) as (
SELECT EMPLOYEEID, concat(FIRSTNAME, ' ',LASTNAME), TITLE, CITY, REGION, COUNTRY, REPORTSTO
FROM ENGAGEDMD_PROD.PUBLIC.EMPLOYEES
),
emp_terr (EMP_ID, TERR_ID) as (
SELECT * FROM ENGAGEDMD_PROD.PUBLIC.EMPLOYEE_TERRITORIES
),
order_dtl (ORDER_ID, PROD_ID, UNIT_PRICE, UNIT_QTY, UNIT_DESC, GROSS_REV, NET_REV) as (
SELECT ORDERID, PRODUCTID, UNITPRICE, QUANTITY, DISCOUNT, (UNITPRICE* QUANTITY), (UNITPRICE* QUANTITY)*(1-DISCOUNT)
FROM ENGAGEDMD_PROD.PUBLIC.ORDER_DETAILS 
),
prod (PROD_ID, PROD_NAME, SUPP_ID, CAT_ID) as (
SELECT PRODUCTID, PRODUCTNAME, SUPPLIERID, CATEGORYID
FROM ENGAGEDMD_PROD.PUBLIC.PRODUCTS
),
ship (SHIP_ID, SHIP_NAME) as (
SELECT SHIPPERID, COMPANYNAME
FROM ENGAGEDMD_PROD.PUBLIC.SHIPPERS
),
terr (TERR_ID, TERR_DESC, REG_ID) as (
SELECT *
FROM ENGAGEDMD_PROD.PUBLIC.TERRITORIES
),
supp (SUPP_ID, SUPP_NAME, SUPP_CITY, SUPP_REGION, SUPP_COUNTRY) as (
SELECT SUPPLIERID, COMPANYNAME, CITY, REGION, COUNTRY
FROM ENGAGEDMD_PROD.PUBLIC.SUPPLIERS
),
reg_emp (EMP_ID, REG_ID, REG_DESC) as (
SELECT DISTINCT et.EMP_ID, r.REGIONID, r.regiondescription 
FROM emp_terr et
    LEFT JOIN terr t
        ON et.TERR_ID = t.TERR_ID
    LEFT JOIN ENGAGEDMD_PROD.PUBLIC.REGIONS r
        ON t.REG_ID = r.REGIONID
 )
,
order_alloc (ORDERID,TOTAL_ORDERS) as (
SELECT ORDERID,SUM(QUANTITY)
FROM ENGAGEDMD_PROD.PUBLIC.ORDER_DETAILS
GROUP BY ORDERID
)    
SELECT 
  o.ORDERID
, o.ORDERDATE
, o.REQUIREDDATE
, o.SHIPPEDDATE
, o.FREIGHT as TOTAL_FREIGHT
, od.UNIT_QTY/oa.TOTAL_ORDERS*o.FREIGHT as FREIGHT_ALLOC
, oa.TOTAL_ORDERS as TOTAL_UNITS
, o.SHIPNAME
, od.UNIT_PRICE
, od.UNIT_QTY
, od.UNIT_DESC
, od.GROSS_REV
, od.NET_REV
, p.PROD_NAME
, ca.CAT_NAME
, ca.CAT_DESC
, c.CUST_NAME
, c.CUST_CITY
, c.CUST_REGION
, c.CUST_COUNTRY
, e.EMP_NAME
, e.EMP_TITLE
, e.EMP_CITY
, e.EMP_REGION
, e.EMP_COUNTRY
, re.REG_DESC
, s.SHIP_NAME 
FROM ENGAGEDMD_PROD.PUBLIC.ORDERS o
    LEFT JOIN order_dtl od
        ON o.ORDERID = od.ORDER_ID
    LEFT JOIN order_alloc oa
        ON oa.ORDERID = o.ORDERID
    LEFT JOIN prod p
        ON od.PROD_ID = p.PROD_ID
    LEFT JOIN cat ca
        ON p.CAT_ID = ca.CAT_ID
    LEFT JOIN cust c
        ON o.CUSTOMERID = c.CUST_ID
    LEFT JOIN emp e
        ON e.EMP_ID = o.EMPLOYEEID
    LEFT JOIN reg_emp re
        ON e.EMP_ID = re.EMP_ID
    LEFT JOIN ship s
        ON o.SHIPVIA = s.SHIP_ID
)
;

SELECT * FROM ENGAGEDMD_PROD.PUBLIC.ENGAGEDMD_CASE_VW
